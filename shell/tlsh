#!/bin/env zsh

# Need to run as ksh to work correctly
if [[ -a ~/.profile ]]; then
	SHELL=/bin/ksh source ~/.profile
fi

# Try to use .zhistory on local box before resorting to using the network
if [[ "$HOST" == "udesktop178" ]]; then
	export HISTFILE=/export/home/joeg/.zhistory
else
	if [[ -a /home/udesktop178/joeg/.zhistory ]]; then
		export HISTFILE=/home/udesktop178/joeg/.zhistory
	else
		export HISTFILE=$HOME/.zhistory
	fi
fi

if [[ `uname -s` = "SunOS" ]]; then
	# Without this I don't get psrinfo
	export PATH=$PATH:/usr/sbin
fi

export DS_DOMAIN="test"

# Use terminfo from the last century
if [[ -d "/opt/tradelink/share/terminfo" ]]; then
	export TERMINFO=/opt/tradelink/share/terminfo
else
	if [[ -d "/opt/app/nonc++/ncurses-5.7/share/terminfo" ]]; then
		export TERMINFO=/opt/app/nonc++/ncurses-5.7/share/terminfo
	else
		if [[ -d "/export/home/joeg/ncurses-install/share/terminfo" ]]; then
			export TERMINFO=/export/home/joeg/ncurses-install/share/terminfo
		fi
	fi
fi

hostname=$(hostname)

if [[ -d /home/$hostname ]]; then
    if [[ ! -a /home/$hostname/joeg ]]; then
	    echo "Creating /home/$hostname/joeg"
	    sudo mkdir /home/$hostname/joeg
	    sudo chgrp develop /home/$hostname/joeg
	    sudo chown joeg /home/$hostname/joeg
	    cd /home/$hostname/joeg
    fi
fi

if [[ "$PWD" = "/home/titan/joeg" ]]; then
    if [[ -a /home/$hostname/joeg ]]; then
	    cd /home/$hostname/joeg
    fi
fi

alias cdl=/home/$hostname/joeg

# 'ls' output is easier to read when colored
if which gls &> /dev/null # Use GNU ls if available
then
	alias ls='gls --color=auto'
else
	alias ls='ls --color=auto'
fi

if which gfind &> /dev/null # Use GNU find if available
then
	alias find='gfind'
fi

if which gmake &> /dev/null # Use GNU make if available
then
	alias make='gmake'
fi

if which ggrep &> /dev/null # Use GNU grep if available
then
	alias grep='ggrep --color=auto'
fi

if which gawk &> /dev/null # Use GNU awk if available
then
	alias awk='gawk'
fi

if which gsed &> /dev/null # Use GNU sed if available
then
	alias sed='gsed'
fi

if which gsleep &> /dev/null # Use GNU sleep if available
then
	alias sleep='gsleep'
fi

if which gtar &> /dev/null # Use GNU tar if available
then
	alias tar='gtar'
fi

if which gcp &> /dev/null # Use GNU cp if available
then
	alias cp='gcp'
fi

if which gstrings &> /dev/null # Use GNU strings if available
then
	alias strings='gstrings'
fi

if which ghead &> /dev/null # Use GNU head if available
then
	alias head='ghead'
fi

# Try to use .zhistory on local box before resorting to using the network
if [[ `basename $SHELL` = "zsh" ]]; then
	if [[ -a /home/udesktop178/joeg/.zshcache ]]; then
		zstyle ':completion:*' cache-path /home/udesktop178/joeg/.zshcache
	else
		zstyle ':completion:*' cache-path $HOME/.zshcache
	fi
fi

# By default SQL is pants on head stupid about keyboard shortcuts
# and arrow keys. rlwrap fixes that.
if which rlwrap &> /dev/null
then
    alias sql='rlwrap sql'
	alias isql='rlwrap isql'
else
	echo "rlwrap not available, so you're stuck with bare sql." >&2
fi

testinstr()
{
	echo "ICACHE:"
	DS_DOMAIN=wslave2a ./mfquery $1 $2 $3 $4 $5 $6 ASK_PRICE BID_PRICE CLOSE_DATE CLOSE_PRICE LAST_PRICE LAST_TIME PREV_DAY_CLOSE_PRICE PREV_DAY_CLOSE_DATE --marketFeedMethod=ICACHE --quit_on_snapshot
	echo "WOMBAT:"
	DS_DOMAIN=wslave2a ./mfquery $1 $2 $3 $4 $5 $6 ASK_PRICE BID_PRICE CLOSE_DATE CLOSE_PRICE LAST_PRICE LAST_TIME PREV_DAY_CLOSE_PRICE PREV_DAY_CLOSE_DATE --marketFeedMethod=WOMBAT --quit_on_snapshot 2> /dev/null
}

# Use newer sybase
export PATH=/opt/app/sybase15/OCS-15_0/bin:$PATH

# Use newer emacs
export PATH=/opt/app/emacs-23.1/bin:$PATH

# icache_wombat eats all my memory when compiled with multiple CPUs
tlsh_file_name=$0
tlmake()
{
    disable -f tlmake
    if [[ `basename $PWD` = "icache_wombat" ]]; then
        echo "Running with 1 CPU. See $tlsh_file_name"
        MAKEFLAGS=-j1 tlmake $@
    else
        tlmake $@
    fi
    enable -f tlmake
}

poor_man_dtrace()
{
    while true
    do
        pstack $1 | gc++filt | head -n ${2:-10}
        sleep 2
        clear
    done
}
