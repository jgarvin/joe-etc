#!/bin/env zsh

local contract="$*"

local mfquery_path
if [[ -a ./mfquery ]]; then
    mfquery_path=./mfquery
else
    mfquery_path=$(which mfquery)
fi

local mfquery_line="$mfquery_path $contract ASK_PRICE BID_PRICE ASK_SIZE BID_SIZE TRADE_VOLUME LAST_PRICE LAST_TIME CUMULATIVE_VOLUME BLOCK_TRADE STRATEGY_LEG_TRADE"

local base_filename=$(echo $contract | sed 's/ /_/g')

for m in ICACHE DS WOMBAT; do;
    eval "$mfquery_line --marketFeedMethod=$m > $base_filename-$m 2>&1" &
done

channel=$(grep $(echo $contract | sed 's/ /:/g') /var/opt/icache/channel-assignment-log | awk '{ print $3 }')

icache_buffer_tool read --include-channels $channel > $base_filename-buffer 2>&1 &
