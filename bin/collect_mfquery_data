#!/bin/env zsh

local contract="$*"

local mfquery_path
if [[ -a ./mfquery ]]; then
    mfquery_path=./mfquery
else
    mfquery_path=$(which mfquery)
fi

local mfquery_line="$mfquery_path $contract ASK_PRICE BID_PRICE ASK_SIZE BID_SIZE TRADE_VOLUME LAST_PRICE LAST_TIME CUMULATIVE_VOLUME BLOCK_TRADE STRATEGY_LEG_TRADE CLOSE_PRICE CLOSE_DAY PREV_DAY_CLOSE_PRICE PREV_DAY_CLOSE_DATE"

local base_filename=$(echo $contract | sed 's/ /_/g')

for m in ICACHE DS WOMBAT; do;
    eval "$mfquery_line --marketFeedMethod=$m > $base_filename-$m 2>&1" &
done

# TODO: Add support for options
local colon_name="$(echo $contract | sed 's/ /:/')"
year_num=$(echo "$colon_name" | awk '{ print $2 }' | sed 's/..\(.*\)/\1/')
month_num=$(month_code $(echo "$colon_name" | awk '{ print $3 }'))

colon_name=$(echo $colon_name | awk '{ print $1 }')$month_num$year_num

query_wombat $colon_name > $base_filename-mamalisten 2>&1 &

instr_query_all $(echo $colon_name | awk -F: '{ print $2 }') > $base_filename-instr_query 2>&1 &

if [ -f /var/opt/icache/channel-assignment-log ]; then
    local channel=$(grep $colon_name /var/opt/icache/channel-assignment-log | awk '{ print $3 }')
    icache_buffer_tool read --include-channels $channel > $base_filename-buffer 2>&1 &
else
    echo >&2 "Not collecting icache data, icache not found."
fi
