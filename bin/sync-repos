#!/usr/bin/env zsh

cd $ZDOTDIR/remote
for i in $(find . -maxdepth 1 -regex '.*[^root]'); do
	# Filter '.' and broken symlinks
	if [ ! "$i" = "." ]  && [ -e "$i" ]; then
			date >> ~/.gitsynclog
			echo $i >> ~/.gitsynclog

			remote_home=$(echo "$i" | sed 's/\.\///') # strip leading ./
			rsync -art "$ZDOTDIR/etc" "$ZDOTDIR/remote/$remote_home"
			cd "$ZDOTDIR/remote/$remote_home"
			HOME="$ZDOTDIR/remote/$remote_home" "etc/shell/setup_symlinks"
	fi >> ~/.gitsynclog 2>&1 &; disown
done
